<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº¦å…‹é£æµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        button:hover {
            background: #5568d3;
        }
        #status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            background: #f3f4f6;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        #volume {
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            margin: 20px 0;
            overflow: hidden;
        }
        #volumeBar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.1s;
        }
        #log {
            background: #2d3748;
            color: #a0aec0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ éº¦å…‹é£æµ‹è¯•å·¥å…·</h1>

        <div>
            <button onclick="testMicrophone()">æµ‹è¯•éº¦å…‹é£</button>
            <button onclick="listDevices()">åˆ—å‡ºéŸ³é¢‘è®¾å¤‡</button>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div id="status">ç‚¹å‡»"æµ‹è¯•éº¦å…‹é£"å¼€å§‹æµ‹è¯•</div>

        <div id="volume">
            <div id="volumeBar"></div>
        </div>

        <div id="log"></div>
    </div>

    <script>
        let audioContext = null;
        let analyzer = null;
        let microphone = null;
        let stream = null;
        let javascriptNode = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            entry.style.margin = '5px 0';

            if (type === 'error') {
                entry.style.color = '#fc8181';
            } else if (type === 'success') {
                entry.style.color = '#68d391';
            }

            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function setStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = type;

            log(message, type);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function listDevices() {
            try {
                log('æ­£åœ¨è¯·æ±‚è®¾å¤‡åˆ—è¡¨...');

                // é¦–å…ˆéœ€è¦è¯·æ±‚æƒé™
                await navigator.mediaDevices.getUserMedia({ audio: true });

                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioInputs = devices.filter(device => device.kind === 'audioinput');

                log(`âœ… æ£€æµ‹åˆ° ${audioInputs.length} ä¸ªéŸ³é¢‘è¾“å…¥è®¾å¤‡ï¼š`, 'success');

                audioInputs.forEach((device, index) => {
                    log(`${index + 1}. ${device.label || 'æœªçŸ¥è®¾å¤‡'} (${device.deviceId})`);
                });

                setStatus(`æ£€æµ‹åˆ° ${audioInputs.length} ä¸ªéº¦å…‹é£è®¾å¤‡`, 'success');

            } catch (error) {
                log(`âŒ åˆ—å‡ºè®¾å¤‡å¤±è´¥: ${error.name} - ${error.message}`, 'error');
                setStatus(`è®¾å¤‡åˆ—è¡¨å¤±è´¥: ${error.name}`, 'error');
            }
        }

        async function testMicrophone() {
            try {
                if (stream) {
                    stopMicrophone();
                }

                log('æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...');
                setStatus('æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...');

                stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                log('âœ… å·²è·å–éº¦å…‹é£æƒé™', 'success');
                setStatus('éº¦å…‹é£æµ‹è¯•ä¸­...', 'success');

                log(`éŸ³é¢‘æµè¯¦æƒ…: ${stream}`);
                log(`éŸ³é¢‘è½¨é“æ•°é‡: ${stream.getAudioTracks().length}`);

                if (stream.getAudioTracks().length === 0) {
                    throw new Error('æœªæ£€æµ‹åˆ°éŸ³é¢‘è¾“å…¥è®¾å¤‡');
                }

                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyzer = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);

                analyzer.smoothingTimeConstant = 0.8;
                analyzer.fftSize = 1024;

                microphone.connect(analyzer);

                log('âœ… éŸ³é¢‘åˆ†æå™¨å·²åˆ›å»º', 'success');

                // å¼€å§‹éŸ³é‡ç›‘æ§
                const bufferLength = analyzer.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                function updateVolume() {
                    analyzer.getByteFrequencyData(dataArray);

                    let sum = 0;
                    for (let i = 0; i < bufferLength; i++) {
                        sum += dataArray[i];
                    }

                    const average = sum / bufferLength;
                    const volumePercent = Math.min(100, (average / 128) * 100);

                    document.getElementById('volumeBar').style.width = volumePercent + '%';

                    requestAnimationFrame(updateVolume);
                }

                updateVolume();

                log('âœ… éŸ³é‡ç›‘æ§å·²å¯åŠ¨', 'success');
                log('è¯·å¯¹ç€éº¦å…‹é£è¯´è¯ï¼Œè§‚å¯ŸéŸ³é‡æ¡å˜åŒ–');

            } catch (error) {
                log(`âŒ éº¦å…‹é£æµ‹è¯•å¤±è´¥: ${error.name}`, 'error');
                log(`é”™è¯¯è¯¦æƒ…: ${error.message}`, 'error');

                let errorMsg = 'éº¦å…‹é£æµ‹è¯•å¤±è´¥ï¼š\n\n';

                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMsg += 'âŒ éº¦å…‹é£æƒé™è¢«æ‹’ç»\n\n';
                    errorMsg += 'è§£å†³æ–¹æ³•ï¼š\n';
                    errorMsg += '1. ç‚¹å‡»æµè§ˆå™¨åœ°å€æ å·¦ä¾§çš„é”å›¾æ ‡\n';
                    errorMsg += '2. æ‰¾åˆ°"éº¦å…‹é£"æƒé™\n';
                    errorMsg += '3. æ”¹ä¸º"å…è®¸"';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMsg += 'âŒ æœªæ£€æµ‹åˆ°éº¦å…‹é£è®¾å¤‡\n\n';
                    errorMsg += 'è§£å†³æ–¹æ³•ï¼š\n';
                    errorMsg += '1. æ£€æŸ¥éº¦å…‹é£æ˜¯å¦è¿æ¥\n';
                    errorMsg += '2. æ£€æŸ¥ç³»ç»Ÿè®¾ç½®ä¸­éº¦å…‹é£æ˜¯å¦è¢«ç¦ç”¨';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMsg += 'âŒ éº¦å…‹é£è¢«å…¶ä»–åº”ç”¨å ç”¨\n\n';
                    errorMsg += 'è§£å†³æ–¹æ³•ï¼š\n';
                    errorMsg += '1. å…³é—­å…¶ä»–ä½¿ç”¨éº¦å…‹é£çš„åº”ç”¨\n';
                    errorMsg += '2. æ£€æŸ¥ç³»ç»Ÿå½•éŸ³è®¾ç½®';
                } else {
                    errorMsg += `é”™è¯¯ï¼š${error.name}\n`;
                    errorMsg += `è¯¦æƒ…ï¼š${error.message}`;
                }

                setStatus(`æµ‹è¯•å¤±è´¥: ${error.name}`, 'error');
                alert(errorMsg);
            }
        }

        function stopMicrophone() {
            if (microphone) {
                microphone.disconnect();
                microphone = null;
            }

            if (analyzer) {
                analyzer.disconnect();
                analyzer = null;
            }

            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            document.getElementById('volumeBar').style.width = '0%';
            log('ğŸ›‘ éº¦å…‹é£å·²åœæ­¢');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹
        window.addEventListener('load', () => {
            log('é¡µé¢å·²åŠ è½½');
            log('æµè§ˆå™¨: ' + navigator.userAgent);
            log('å½“å‰URL: ' + window.location.href);

            // æ£€æŸ¥æ˜¯å¦æ”¯æŒ getUserMedia
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                log('âŒ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ getUserMedia API', 'error');
                setStatus('æµè§ˆå™¨ä¸æ”¯æŒ', 'error');
            } else {
                log('âœ… æµè§ˆå™¨æ”¯æŒ getUserMedia API', 'success');
            }
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            stopMicrophone();
        });
    </script>
</body>
</html>
