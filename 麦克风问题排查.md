# 麦克风问题排查指南

## 问题描述

浏览器已经允许使用麦克风权限，但网页认为无麦克风权限。

## 已修复的问题

### 1. 简化音频配置

**问题**：使用了较新的音频参数（`echoCancellation`、`noiseSuppression`、`autoGainControl`），在某些浏览器上可能不支持。

**修复**：改为使用最简单的 `{ audio: true }` 配置，确保最大兼容性。

### 2. 详细的错误提示

**修复**：
- 添加了详细的错误日志
- 根据不同的错误类型提供具体的解决方法
- 控制台会显示完整的错误信息

### 3. 页面加载时检测

**新增功能**：
- 页面加载时自动检测麦克风设备
- 列出所有检测到的音频设备
- 如果检测失败，显示警告提示

### 4. 麦克风测试功能

**新增功能**：
- 添加"测试麦克风"按钮
- 可以在不加入语音的情况下测试麦克风
- 实时显示音量级别
- 直观地反馈麦克风工作状态

## 使用测试功能

### 1. 查看浏览器控制台

按 `F12` 打开开发者工具，切换到 `Console` 标签：

**正常情况**：
```
正在检测麦克风设备...
✅ 检测到 1 个音频输入设备：
1. 麦克风 (Realtek(R) Audio) (default)
```

**失败情况**：
```
❌ 麦克风检测失败: NotAllowedError
错误名称: NotAllowedError
错误消息: Permission denied
```

### 2. 使用测试按钮

点击页面上的"🔊 测试麦克风"按钮：

- **正常**：显示音量指示器，说话时会变化
- **失败**：显示详细的错误信息

### 3. 检查权限

#### Chrome

1. 点击地址栏左侧的锁图标 🔒
2. 找到"麦克风"权限
3. 确保设置为"允许"
4. 如果已设置为"允许"：
   - 点击"重置权限"
   - 刷新页面
   - 再次允许

#### Firefox

1. 点击地址栏左侧的图标
2. 点击"权限"标签
3. 找到"使用麦克风"
4. 勾选"允许"
5. 刷新页面

#### Edge

1. 点击地址栏左侧的锁图标
2. 找到"麦克风"权限
3. 设置为"允许"
4. 刷新页面

#### Safari (macOS)

1. 打开"系统偏好设置" > "安全性与隐私" > "麦克风"
2. 找到浏览器应用
3. 勾选允许

## 常见错误及解决方法

### NotAllowedError / PermissionDeniedError

**症状**：
- 浏览器弹出权限提示时点击了"拒绝"
- 或权限被系统限制

**解决方法**：

1. **浏览器设置**：
   ```
   Chrome: 设置 > 隐私和安全 > 网站设置 > 麦克风
   找到 localhost，设置为"允许"
   ```

2. **Windows 设置**：
   ```
   设置 > 隐私 > 麦克风
   确保"允许应用访问麦克风"已开启
   ```

3. **刷新页面**：
   - 按 `Ctrl + F5` 强制刷新
   - 重新点击"加入语音"

### NotFoundError / DevicesNotFoundError

**症状**：
- 未检测到麦克风设备
- 麦克风被系统禁用

**解决方法**：

1. **检查物理连接**：
   - 确保麦克风已正确插入
   - 尝试不同的 USB 端口
   - 如果是 USB 麦克风，更换数据线

2. **检查系统设置**：

   **Windows**：
   ```
   右键点击任务栏音量图标 > 打开音量混合器
   确保麦克风未被静音
   ```

   **设置 > 系统 > 声音**
   - 选择正确的输入设备
   - 调整音量级别

3. **设备管理器**：
   ```
   右键"此电脑" > 管理 > 设备管理器
   展开音频输入和输出
   检查是否有黄色感叹号
   ```

### NotReadableError / TrackStartError

**症状**：
- 麦克风被其他应用占用
- 驱动程序问题

**解决方法**：

1. **关闭其他应用**：
   - 关闭所有使用麦克风的应用
   - 检查是否有后台录音程序

2. **重启浏览器**：
   - 完全关闭浏览器（检查任务管理器）
   - 重新打开

3. **检查隐私设置**：
   ```
   Windows: 设置 > 隐私 > 相机
   确保"允许桌面应用访问相机"已开启（有时会影响麦克风）
   ```

### OverconstrainedError / ConstraintNotSatisfiedError

**症状**：
- 请求的音频配置不被支持

**解决方法**：
- 本代码已修复，使用最简单的配置
- 如果仍然出现，尝试更换浏览器

## 高级排查

### 1. 检查 HTTPS

**重要**：
- 本地测试（localhost）可以使用 HTTP
- 公网部署必须使用 HTTPS

**原因**：浏览器安全策略，非 HTTPS 环境下不允许访问媒体设备。

### 2. 检查浏览器版本

支持的最低版本：
- Chrome 23+
- Firefox 22+
- Safari 11+
- Edge (所有版本)

**检查方法**：
```
Chrome: chrome://settings/help
Firefox: Firefox 菜单 > 帮助 > 关于 Firefox
```

### 3. 检查虚拟机

如果你在虚拟机中运行：
- 确保虚拟机已启用音频设备
- 检查虚拟机设置中的音频配置

### 4. 检查防火墙

某些防火墙软件可能阻止麦克风访问：
- 临时禁用防火墙测试
- 将浏览器添加到信任列表

## 调试步骤

### 完整的调试流程

1. **打开控制台**：按 `F12`，切换到 `Console` 标签

2. **查看日志**：
   ```
   正常：✅ 已获取麦克风权限
   异常：❌ 获取麦克风失败: ...
   ```

3. **测试麦克风**：点击"测试麦克风"按钮
   - 查看音量指示器
   - 对着麦克风说话

4. **检查设备列表**：
   ```
   浏览器控制台输入：
   navigator.mediaDevices.enumerateDevices()
     .then(devices => console.log(devices.filter(d => d.kind === 'audioinput')))
   ```

5. **重新授予权限**：
   - 刷新页面
   - 点击"加入语音"
   - 点击"允许"

## 其他浏览器尝试

如果问题仍然存在：

1. **更换浏览器**：
   - Chrome 用户尝试 Firefox
   - Firefox 用户尝试 Chrome

2. **无痕模式**：
   - Chrome: Ctrl + Shift + N
   - Firefox: Ctrl + Shift + P

3. **隐身窗口**：
   - 测试是否是扩展程序导致的问题

## 联系支持

如果以上方法都无法解决：

1. **收集信息**：
   - 浏览器名称和版本
   - 操作系统版本
   - 错误信息（从控制台复制）
   - 麦克风设备名称

2. **在 GitHub 上创建 Issue**：
   - 提供详细的错误日志
   - 说明已尝试的解决方法

## 总结

修复后的代码现在包括：

✅ 简化的音频配置（最大兼容性）
✅ 详细的错误提示和解决方法
✅ 页面加载时自动检测
✅ 麦克风测试功能
✅ 完整的调试日志

请刷新页面（Ctrl + F5），然后：
1. 先点击"测试麦克风"
2. 如果测试成功，再点击"加入语音"
3. 查看控制台的详细日志

如果仍有问题，请按照上述排查步骤逐一检查。
