# P2P 语音聊天室 - 测试指南

## 问题修复总结

### 已修复的问题

1. ✅ **const 变量赋值错误**
   - 将 `const localStream = null` 改为 `let localStream = null`
   - 现在可以正确赋值

2. ✅ **简化音频配置**
   - 移除了可能不兼容的音频参数
   - 使用最简单的 `{ audio: true }` 配置

3. ✅ **添加麦克风测试功能**
   - 新增"测试麦克风"按钮
   - 可以在不加入语音的情况下测试

4. ✅ **添加详细的错误提示**
   - 区分不同类型的错误
   - 提供具体的解决方法

## 快速测试步骤

### 1. 启动服务器

```bash
双击：启动服务器.bat
```

或手动运行：
```bash
npm install
npm start
```

**预期输出**：
```
========================================
  P2P 语音聊天室服务器已启动
========================================
  访问地址: http://localhost:3000
  端口: 3000
========================================
  提示: 生产环境请使用 HTTPS
========================================
```

### 2. 使用麦克风测试工具

**目的**：在不进入语音房间的情况下测试麦克风是否正常工作

**步骤**：
1. 访问：`http://localhost:3000/test-mic.html`
2. 点击"测试麦克风"按钮
3. 对着麦克风说话
4. 观察音量条变化

**预期结果**：
- 点击按钮后弹出权限提示
- 点击"允许"后显示"麦克风测试中..."
- 对着麦克风说话时，音量条会变化
- 页面底部显示详细日志

**如果失败**：
- 查看页面上的错误提示
- 查看浏览器控制台（F12）的日志
- 参考"麦克风问题排查.md"

### 3. 测试主应用

**步骤**：
1. 访问：`http://localhost:3000`
2. 输入用户名（例如：张三）
3. 输入房间号（例如：room1）
4. 点击"进入房间"
5. 点击"🔊 测试麦克风"
6. 如果测试成功，点击"🎤 加入语音"

**预期结果**：
- 进入房间后可以看到自己的用户卡片
- 点击"测试麦克风"后能看到音量反馈
- 点击"加入语音"后麦克风指示器闪烁
- 控制台显示"✅ 已获取麦克风权限"

### 4. 双人通话测试

**用户 A**：
1. 用户名：张三
2. 房间号：room1
3. 点击"加入语音"

**用户 B**：
1. 用户名：李四
2. 房间号：room1
3. 点击"加入语音"

**预期结果**：
- 双方都能在用户列表中看到对方
- 双方的用户卡片显示"🎤 语音中"
- 双方可以听到对方的声音
- 控制台显示 WebRTC 连接日志

### 5. 多人会议测试

重复步骤 4，添加更多用户：
- 用户 C：王五，房间号：room1
- 用户 D：赵六，房间号：room1

**预期结果**：
- 所有用户都能看到彼此
- 所有用户显示"🎤 语音中"
- 多方可以同时通话

## 浏览器控制台日志说明

### 正常的日志流程

**进入房间**：
```
WebSocket 已连接
[连接] 用户 xxx 从 ::1 连接
[加入] 张三 加入房间 room1
[房间 room1] 当前用户数: 1
收到消息: room-users
更新用户列表: []
```

**测试麦克风**：
```
正在请求麦克风权限...
✅ 已获取麦克风权限
音频流详情: [object MediaStream]
音频轨道数量: 1
音频轨道状态: live
音频轨道标签: 麦克风 (Realtek(R) Audio)
✅ 已加入语音
```

**建立 P2P 连接**：
```
创建与 李四 的连接，发起方: true
已发送 offer
收到消息: offer
创建与 张三 的连接，发起方: false
收到消息: answer
已设置远程描述
已添加 ICE candidate
```

**接收对方音频**：
```
收到 李四 的音频流
```

### 错误日志及解决

**NotAllowedError**：
```
❌ 获取麦克风失败: NotAllowedError
错误名称: NotAllowedError
错误消息: Permission denied
```
**解决**：在浏览器设置中重新授予权限

**NotFoundError**：
```
❌ 获取麦克风失败: NotFoundError
错误名称: NotFoundError
错误消息: Requested device not found
```
**解决**：检查麦克风是否连接

**NotReadableError**：
```
❌ 获取麦克风失败: NotReadableError
错误名称: NotReadableError
错误消息: Could not start audio source
```
**解决**：关闭其他使用麦克风的应用

## 浏览器兼容性测试

### Chrome

**测试版本**：Chrome 120+

**测试步骤**：
1. 访问 `http://localhost:3000/test-mic.html`
2. 点击"测试麦克风"
3. 点击"列出音频设备"

**预期结果**：✅ 完全支持

### Firefox

**测试版本**：Firefox 120+

**测试步骤**：同上

**预期结果**：✅ 完全支持

### Safari (macOS)

**测试版本**：Safari 17+

**测试步骤**：
1. 访问 `http://localhost:3000/test-mic.html`
2. 点击"测试麦克风"
3. 注意：需要在系统设置中先允许 Safari 访问麦克风

**预期结果**：✅ 支持

### Edge

**测试版本**：Edge 120+

**测试步骤**：同 Chrome

**预期结果**：✅ 完全支持

## 性能测试

### 延迟测试

**方法**：
1. 两个用户加入同一房间
2. 用户 A 拍手
3. 用户 B 计算听到声音的时间

**预期结果**：延迟 < 100ms

### 音质测试

**测试方法**：
1. 两人进行正常对话
2. 检查音质是否清晰
3. 检查是否有回声

**预期结果**：音质清晰，无明显回声

### 多人并发测试

**测试方法**：
1. 3-5 个用户加入同一房间
2. 同时说话测试
3. 检查是否都能正常听到

**预期结果**：支持多人同时语音

## 故障排查清单

如果遇到问题，请按以下顺序检查：

- [ ] 服务器是否正在运行
- [ ] 浏览器控制台是否有 JavaScript 错误
- [ ] 是否已经允许麦克风权限
- [ ] 使用"测试麦克风"功能验证
- [ ] 检查设备列表中是否有麦克风
- [ ] 尝试不同的浏览器
- [ ] 检查系统音量设置
- [ ] 关闭其他使用麦克风的应用
- [ ] 查看详细的错误日志

## 成功标准

✅ 测试通过的标准：

1. **麦克风测试工具**：可以正常检测和测试麦克风
2. **单人进入**：可以成功进入房间
3. **双人通话**：可以建立 P2P 连接并双向通话
4. **多人会议**：支持 3 人以上同时语音
5. **音频质量**：音质清晰，延迟低
6. **错误处理**：有友好的错误提示

## 下一步

测试通过后：

1. **部署到服务器**：使用 HTTPS 部署到公网
2. **添加更多功能**：文字聊天、视频通话等
3. **优化性能**：TURN 服务器、更好的音质等
4. **移动端测试**：在手机和平板上测试

## 获取帮助

如果遇到问题：

1. **查看详细日志**：F12 打开控制台
2. **使用测试工具**：test-mic.html 验证麦克风
3. **阅读排查文档**：麦克风问题排查.md
4. **检查浏览器兼容性**：确保使用支持的浏览器

祝你测试顺利！🎤
